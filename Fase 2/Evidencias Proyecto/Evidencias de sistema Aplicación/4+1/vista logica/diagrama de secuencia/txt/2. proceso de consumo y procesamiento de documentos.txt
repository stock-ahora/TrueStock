    title 2. Proceso de consumo y procesamiento de documentos

    participant RabbitMQ
    participant Api Stock
    participant TextTract
    participant Bedrock
    participant DB

    RabbitMQ-->>Api Stock: Entrega información de la cola

note right of RabbitMQ:mensaje entregado\n\n{\n  "event_id": "123e4567-e89b-12d3-a456-426614174000",\n  "event_type": "process_request",\n  "occurred_at": "2024-06-10T15:04:05Z",\n  "version": "1.0",\n  "correlation_id": "abc-123",\n  "source": "api_gateway",\n  "headers": {\n    "Authorization": "Bearer token",\n    "Content-Type": "application/json"\n  },\n  "request_id": "987e6543-e21b-12d3-a456-426614174111",\n  "client_account_id": "456e7890-e12b-12d3-a456-426614174222",\n  "type_ingress": 1 // esto puede ser 1 o -1\n}\n

    Api Stock->>TextTract: Ingresa documento a textTract\n
    
    note right of Api Stock:A textract se envia la key y el bucket donde se encuentrarn \nlos archivos que se tienen que procesar para \nextraer su detalle\n\nkey: ubicacion en el bucket\nbucket: nombre del bucket\ntype de analisis: preferencias para analizar el documento
    
alt reintento de subida

Api Stock<--TextTract:Documento Se encuentra procesando
Api Stock->TextTract:Se reintenta la subida a textract
end
Api Stock<--TextTract:Entrega los productos que se encuentran el la factura


Api Stock->Api Stock:Preparar el promp con los datos de los productos encontrados
    Api Stock->>Bedrock: Envió del promp con los productos encontrados, para que los fórmate en un formato valido.
box right of Api Stock:Ejemplo del prompt\n\nEntrada: "{Datos de entrada que entrego textTract}"\nDevuelve un JSON válido con este formato, en caso de que sean mas de un producto devuelve un array de productos, cada \nproducto con su nombre, cantidad y genera SKUs si no tiene ningun codigo o sku en el detalle con los nombres de 10 digitos \npara poder compararlos con una tabla que tengo en mi db, para la generacion del sku solo considera el nombre y no agregues\nnumeros si no tiene en el nombre en mayusculas, y solo genera max 3 skus si no viene algun codigo en el detalle, ademas considera \nla respuesta solo el json, no agregues texto adicional, ademas la cantidad\ntienen que venir como numero entero, si no hay productos devuelve un array vacio:\n{\n  "name": "nombre del producto",\n  "count": "cantidad de productos",\n  "skus": ["sku1", "sku2", "sku3"]\n}`, input)\n\n	body := fmt.Sprintf(`{\n      "messages": [\n        {\n          "role": "user",\n          "content": [\n            { "text": %q }\n          ]\n        }\n      ],\n      "inferenceConfig": {\n        "maxTokens": 712,\n        "temperature": 0\n      }\n    }
Api Stock<--Bedrock:Entrega de los productos formateados en un formato que el aplicativo go entienda.
note right of Api Stock:json de saluda \n\n{\n"name": "basos",\n"count": 1,\n"skus": ["bso", "bsos", "bos"]\n}
alt actualizacion de stock

Api Stock->DB:Update producto, si encuentra el sku lo actualiza y si no crea un nuevo producto en conjunto de un producto
Api Stock<-DB:insert o update realizado
end





RabbitMQ<-Api Stock:Envio de movimientos a cola de movimientos
RabbitMQ-->Api Stock:Confirmacion de envio
RabbitMQ<-Api Stock:Envio de notificaciones
RabbitMQ-->Api Stock:Confirmación de envio